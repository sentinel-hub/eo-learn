image: python:3.9

stages:
  - test
  - build

run_sh_integration_tests:
  stage: test
  when: always
  before_script:
    - apt-get update
    - apt-get install -y build-essential libgdal-dev graphviz proj-bin gcc libproj-dev libspatialindex-dev
  script:
    - pip install .[DEV]
    - sentinelhub.config --sh_client_id "$SH_CLIENT_ID" --sh_client_secret "$SH_CLIENT_SECRET" > /dev/null # Gitlab can't mask SH_CLIENT_SECRET in logs
    - pytest -m sh_integration

build_docker_image:
  stage: build
  needs: []
  rules:
    - if: $GITHUB_REF =~ /^refs\/tags\// || $GITHUB_REF == "test123" # run only on releases
      when: always
      variables:
        CUSTOM_RUN_TAG: auto # this will create images with the latest tag and the version tag
        LAYER_NAME: dotai-eo
    - when: manual
  trigger:
    project: teams/eor/dotai/infra
  allow_failure: true
